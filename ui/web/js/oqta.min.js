var keyupStack,statusIcons,selectedSearchItem,bt;function buildList(f){for(var i=document.getElementById('driveList'),b=1,h,e,c,a,d,g;b<=f.length;b++)h=document.createElement('form'),i.appendChild(h),e=document.createElement('div'),e.className='row',h.appendChild(e),c=document.createElement('input'),c.className='custom-file-input',c.id='fc'+b,c.type='file',c.accept='.mdr,.MDR,.mdv,.MDV,.z80,.Z80',c.style='display:none;',c.onclick=function(){this.value=null},c.onchange=function(){var a=this.files[0].name,b=this.id.substring(2);indicateLoading(b),upload(b,getName(a),getFormat(a),this.files[0],!1)},e.appendChild(c),a=document.createElement('div'),a.className='col-2',d=document.createElement('input'),d.className='btn btn-outline-light mb-1',d.id='bt'+b,d.type='button',d.value=b,d.onclick=function(){var a=this.id.substring(2);loadSelectedSearchItem(a)||document.getElementById('fc'+a).click()},configureButton(d,f[b-1]),a.appendChild(d),e.appendChild(a),a=document.createElement('div'),a.id='name'+b,a.className='col-7',a.align='left',setName(a,f[b-1]),a.onclick=function(){showFiles(this.id.substring(4))},e.appendChild(a),a=document.createElement('div'),a.className='col-3',g=document.createElement('i'),g.id='it'+b,setStatusIcon(g,f[b-1]),a.appendChild(g),e.appendChild(a)}function update(a){updateClient(a.client),updateList(a.drives)}function updateClient(a){if(a=="")return;var b="connected";a=='<unknown>'&&(b='disconnected',a='disconn.'),document.getElementById('clientIcon').className=getStatusIcon(b),document.getElementById('clientLabel').innerHTML=a}function updateList(c){var a,b;if(c==null)return;for(a=1;a<=c.length;a++)b=c[a-1],setStatusIcon(document.getElementById('it'+a),b),setName(document.getElementById('name'+a),b),configureButton(document.getElementById('bt'+a),b)}function indicateLoading(a){document.getElementById('bt'+a).disabled=!0,document.getElementById('name'+a).innerHTML='&lt; loading &gt;',document.getElementById('it'+a).className=getStatusIcon('loading')}function upload(b,c,d,e,f){var a='/drive/'+b+'?type='+d+'&repair=true&name='+encodeURIComponent(c);f&&(a+="&ref=true"),fetch(a,{method:'PUT',body:e}).then(a=>a.json()).then(a=>console.log(a)).catch(a=>console.log('error: '+a))}function resetClient(){fetch('/resync?reset=true',{method:'PUT'}).then(function(){}).then(a=>console.log(a)).catch(a=>console.log('error: '+a))}function configureButton(b,a){b.disabled=a.status=='busy'||a.status=='hardware'}function setName(b,a){(a.name!=""||a.status!='busy')&&(a.formatted?b.innerHTML=a.name:a.status=='hardware'?b.innerHTML='&lt; h/w drive &gt;':b.innerHTML='&lt; unformatted &gt;')}function setStatusIcon(c,a){var b=a.status;a.status=='idle'&&(a.modified?b='modified':a.writeProtected?b='writeProtected':a.formatted||(b='unformatted')),c.className=getStatusIcon(b)}function showFiles(a){fetch('/drive/'+a+'/list',{headers:{'Content-Type':'application/json'}}).then(a=>a.text()).then(b=>updateFileList(a,b)).catch(a=>console.log('error: '+a)),showTab('files')}function updateFileList(b,c){var d=document.getElementById('fileList'),a;d.innerHTML='drive '+b+': '+c.trim(),a=document.getElementById('btSave'),a.name=b,a.disabled=!1,a=document.getElementById('btUnload'),a.name=b,a.disabled=!1}function operateDrive(a,b){var c='/drive/'+a;switch(b){case'save':alert("SAVE coming soon");return;break;case'unload':c+='/unload?force=true',userConfirm("Unload cartridge?","Unsaved changes will be lost!",function(d){d&&operateDriveDo(a,b,c)});break;default:return}}function operateDriveDo(c,a,b){fetch(b,{headers:{'Content-Type':'application/json'}}).catch(a=>console.log('error: '+a)),a=='unload'&&showTab('drives')}keyupStack=[];function setupSearch(){var a=document.getElementById('repo-search'),b;a.addEventListener('keyup',function(){keyupStack.push(1),setTimeout(function(){keyupStack.pop(),keyupStack.length===0&&search(this.value)}.bind(this),600)}),b=document.getElementById('btSearch'),b.onclick=function(){search(a.value)}}function search(a){if(a.length<2)return;fetch('/search?items=25&term='+encodeURIComponent(a),{headers:{'Content-Type':'text'}}).then(a=>a.text()).then(a=>updateSearchResults(a)).catch(a=>console.log('error: '+a))}function updateSearchResults(b){var a=document.getElementById('search-results');a.textContent=null,b.split("\n").forEach(function(c){if(c=="")return;var b=document.createElement('li');b.className="list-group-item text-white bg-dark",b.align="left",b.onclick=function(){searchItemSelected(this.innerHTML)},b.appendChild(document.createTextNode(c)),a.appendChild(b)})}function searchItemSelected(a){userConfirm("Load cartridge?","Confirm & click the load button of the drive into which you want to load.",function(b){b?(selectedSearchItem="repo://"+a,showTab('drives')):selectedSearchItem=""})}function loadSelectedSearchItem(a){return selectedSearchItem!=""&&(indicateLoading(a),upload(a,getName(selectedSearchItem),getFormat(selectedSearchItem),selectedSearchItem,!0),selectedSearchItem="",!0)}statusIcons={empty:'bi-none',idle:'bi-app',busy:'bi-caret-right-square',hardware:'bi-gear',unformatted:'bi-hr',writeProtected:'bi-lock',modified:'bi-app-indicator',connected:'bi-plug-fill',disconnected:'bi-plug',loading:'bi-hourglass-split'};function getStatusIcon(a){return statusIcons[a]}async function subscribe(){let a=await fetch('/watch',{headers:{'Content-Type':'application/json'}});switch(a.status){case 502:break;case 200:let b=await a.json();update(b);break;default:console.log(a.statusText),await new Promise(a=>setTimeout(a,1e3));break}await subscribe()}function getFormat(a){var b=a.lastIndexOf('.');return a.substring(b+1)}function getName(a){var c=a.lastIndexOf('/'),b=a.substring(c+1),d=b.lastIndexOf('.');return b.substring(0,d)}function userConfirm(d,e,c){var a=document.getElementById('modal'),b;a.querySelector('.modal-title').textContent=d,a.querySelector('.modal-body').textContent=e,b=new bootstrap.Modal(a,null),a.querySelector('.btn-primary').onclick=function(){b.hide(),c(!0)},a.querySelector('.btn-secondary').onclick=function(){b.hide(),c(!1)},b.show()}async function showTab(a){var b=document.querySelector('a[data-bs-target="#'+a+'"]');bootstrap.Tab.getOrCreateInstance(b).show()}selectedSearchItem="",fetch('/list',{headers:{'Content-Type':'application/json'}}).then(a=>a.json()).then(a=>buildList(a)).catch(a=>console.log('error: '+a)),fetch('/status',{headers:{'Content-Type':'application/json'}}).then(a=>a.json()).then(a=>updateClient(a.client)).catch(a=>console.log('error: '+a)),document.getElementById('btClient').onclick=function(){resetClient()},bt=document.getElementById('btSave'),bt.onclick=function(){operateDrive(this.name,'save')},bt.disabled=!0,bt=document.getElementById('btUnload'),bt.onclick=function(){operateDrive(this.name,'unload')},bt.disabled=!0,setupSearch(),subscribe()